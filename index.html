<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Entrainement au langage SQL</title>
    <style>
        body {
            font-family: monospace;
            font-size: 12pt;
            background-color: white;
        }
        #requete {
            border: 1px solid black;
            resize: none;
            width: 590px;
            margin: 0px;
            font-size: 12pt;
            padding: 4px;
        }
        #requete-container {
            text-align: center;
            width: 600px;
            margin: 2px auto;
            padding: 0px
        }
        #reponse-container {
            background-color: black;
            color: white;
            width: 600px;
            height: 500px;
            margin: 2px auto;
            padding: 0px;
        }
        #reponse {
            margin: 0px;
            padding: 4px;
            height: 100%;
            width: 100%;
            overflow: scroll;
            white-space: nowrap;
        }
    </style>
</head>

<body>
    <div id="reponse-container">
        <p id="reponse"></p>
    </div>
    <form id="requete-container">
        <textarea id="requete" rows=3></textarea>
        <input type="submit" value="Envoyer la requête." />
    </form>
    <script language="javascript">
        const mainKeywords = {
            "SHOW": show,
            "USE": use,
            "DESC": describe,
            "DESCRIBE": describe,
            "SELECT": select,
            "INSERT": unimplemented,
            "UPDATE": unimplemented,
            "DELETE": unimplemented,
            "MERGE": unimplemented,
            "TRUNCATE": unimplemented,
            "CREATE": unimplemented,
            "DROP": unimplemented,
            "ALTER": unimplemented,
            "RENAME": unimplemented,
        }
        const databases = []
        var currentDatabase = null
        class Database {
            constructor(nom) {
                this.nom = nom
                this.tables = []
            }
        }
        class Table {
            constructor(nom) {
                this.nom = nom
                this.columns = []
                this.data = []
            }
        }
        class Column {
            constructor(nom, type) {
                this.type = type
                this.nom = nom
            }
        }
        class SearchColumn {
            constructor(nom) {
                const liste = nom.split(".")
                this.nom = nom
                this.alias = nom
                this.table = null
                if (liste.length == 2) {
                    this.nom = liste[1]
                    this.table = liste[0]
                }
                this.index = null
            }
        }
        class SearchTable {
            constructor(nom) {
                this.nom = nom
                this.alias = nom
                this.index = null
            }
        }
        /*
         * produit cartésien d'une liste de n listes
         */
        function produitCartesien(L) {
            return L.reduce((acc, cur) => {
                var rep = []
                if (acc.length) {
                    for (i=0; i<acc.length; i++) {
                        for (j=0; j<cur.length; j++) {
                            rep.push(acc[i].concat([cur[j]]))
                        }
                    }
                } else {
                    rep = cur.map(elem => [elem])
                }
                return rep
            }, [])
        }
        /*
         * vérifie que le nom ne comporte que des lettres, des chiffres et/ou le caractère _
         */
        function checkName(nom) {
            const regex = /^\w+$/g
            if (regex.test(nom)) {
                return true
            } else {
                print(`Le nom "${nom}" contient des caractères interdits`)
                return false
            }
        }
        /*
         * ajoute autant d'espace que necessaire pour obtenir une chaine de bonne longueur.
         * si le texte est trop long, retourne le texte tel quel.
         */
        function expandText(texte, longueur) {
            if (longueur>=texte.length) {
                return texte + "&nbsp;".repeat(longueur-texte.length)
            } else {
                return texte
            }
        }
        /*
         * affiche une ligne dans le cadre 'réponse'
         */
        function print(texte) {
            const p = document.getElementById("reponse")
            p.innerHTML += texte+"<br/>"
            p.scrollTop = p.scrollHeight;
        }
        /*
         * affiche des données sous la forme d'un tableau dans le cadre 'réponse'
         */
        function printTable(data) {
            const entete = data[0]
            var largeurs = entete.map(col => col.toString().length)
            for (let i=1; i<data.length; i++) {
                largeurs = data[i].map((col, j) => Math.max(largeurs[j], col.toString().length))
            }
            const ligne = "+" + largeurs.map(l => '-'.repeat(l+2)).join("+") + "+"
            print(ligne)
            data.forEach(row => {
                print("| " + row.map((col, i) => expandText(col.toString(), largeurs[i])).join(" | ") + " |")
                print(ligne)
            })
            print(`${data.length-1} ${data.length>2?"lignes":"ligne"}`)
        }
        /*
         * vérifie que le mot clé de 'requete' à la position 'index' est dans 'dictionnaire'
         */
        function checkKeyword(requete, index, dictionnaire) {
            if (requete.length > index) {
                const keyword = requete[index].toUpperCase()
                if (dictionnaire[keyword]) {
                    dictionnaire[keyword](requete, index)
                } else {
                    print(`Mot clé "${keyword}" inattendu`)
                }
            } else {
                print("Requete incomplète")
            }
        }
        /*
         * traite le mot-clé mysql 'SHOW'
         */
        function show(requete, index) {
            const nextKeywords = {
                "DATABASES": showDatabases,
                "TABLES": showTables
            }
            checkKeyword(requete, index+1, nextKeywords)
        }
        /*
         * traite la commande mysql 'SHOW DATABASES'
         */
        function showDatabases(requete, index) {
            const dblist = databases.map(db => [db.nom])
            dblist.unshift(["DATABASES"])
            printTable(dblist)
        }
        /*
         * traite la commande mysql 'SHOW TABLES'
         */
        function showTables(requete, index) {
            if (currentDatabase) {
                const tablesList = currentDatabase.tables.map(db => [db.nom])
                tablesList.unshift([`TABLES in ${currentDatabase.nom}`])
                printTable(tablesList)
            } else {
                print("Aucune base de données sélectionnée")
            }
        }
        /*
         * traite la commande mysql 'USE'
         */
        function use(requete, index) {
            if (requete.length > index + 1) {
                const nom = requete[index+1]
                if (checkName(nom)) {
                    dbList = databases.filter(db => db.nom.toUpperCase() == nom.toUpperCase())
                    if (dbList.length) {
                        currentDatabase = dbList[0]
                        print(`La base de données "${nom}" a bien été selectionnée.`)
                    } else {
                        print(`Erreur, il n'y a aucune base de données nomée "${nom}".`)
                    }
                }
            } else {
                print("Requete incomplète")
            }
        }
        /*
         * traite la commande mysql 'DESCRIBE'
         */
        function describe(requete, index) {
            if (currentDatabase) {
                const db = currentDatabase
                if (requete.length > index + 1) {
                    const nom = requete[index+1]
                    if (checkName(nom)) {
                        tableList = db.tables.filter(table => table.nom.toUpperCase() == nom.toUpperCase())
                        if (tableList.length) {
                            const infos = tableList[0].columns.map(lbl => [lbl.nom, lbl.type])
                            infos.unshift(["COLUMN'S NAME", "TYPE"])
                            printTable(infos)
                        } else {
                            print(`Erreur, il n'y a aucune table nomée "${nom}" dans la base de données ${db.nom}.`)
                        }
                    }
                } else {
                    print("Requete incomplète")
                }
            } else {
                print("Aucune base de données sélectionnée")
            }
        }
        /*
         * recherche (récursivement) le nom des colonnes à afficher pour un SELECT FROM
         */
        function exploreColumns(requete, index, columnsList) {
            if (requete.length > index+2 && requete[index+2] == ',') {
                columnsList.push(new SearchColumn(requete[index+1]))
                return exploreColumns(requete, index+2, columnsList)
            } else if (requete.length > index+1) {
                columnsList.push(new SearchColumn(requete[index+1]))
                return [true, index+1, columnsList]
            } else {
                return [false, index, columnsList]
            }
        }
        /*
         * recherche (récursivement) le nom des sources de données et eventuellement les alias avant de faire un SELECT FROM
         */
        function exploreTables(requete, index, tablesList) {
            if (requete.length > index+2 && requete[index+2] == ',') {
                tablesList.push(new SearchTable(requete[index+1]))
                return exploreTables(requete, index+2, tablesList)
            } else if (requete.length > index+1) {
                tablesList.push(new SearchTable(requete[index+1]))
                return [true, index+1, tablesList]
            } else {
                return [false, index, tablesList]
            }
        }
        /*
         * retrouve les tables utilisées et trouve l'index des colonnes avant de faire un SELECT FROM
         */
        function checkSelectFrom(columnsList, tablesList) {
            const db = currentDatabase
            const allTablesNames = db.tables.map(table => table.nom)
            const searchTablesNom = tablesList.map(table => table.nom)
            const searchTablesAlias = tablesList.map(table => table.alias)
            const searchTablesAll = searchTablesNom.concat(searchTablesAlias);
            const allColumnsNames = []
            var valide = true
            /* vérification des tables */
            tablesList.forEach(table => {
                const index = allTablesNames.indexOf(table.nom)
                if (index > -1) {
                    table.index = index
                    Array.prototype.push.apply(allColumnsNames, db.tables[index].columns.map(col => col.nom));
                } else {
                    print(`La table "${table.nom}" n'existe pas dans la base de données "${currentDatabase.nom}"`)
                    valide = false
                }
            })
            /* vérification des colonnes */
            if (valide) {
                columnsList.forEach(col => {
                    if (col.table) {
                        const tableIndex = searchTablesAll.indexOf(col.table)
                        if (tableIndex > -1) {
                            const table = db.tables[tablesList[tableIndex % tablesList.length].index]
                            const colIndex = table.columns.map(col => col.nom).indexOf(col.nom)
                            if (colIndex > -1) {
                                col.table = table
                                col.index = colIndex
                            } else {
                                print(`La colonne "${col.nom}" n'existe pas dans la table "${table.nom}"`)
                            }
                        } else {
                            print(`La table "${col.table}" n'existe pas dans la base de données "${currentDatabase.nom}"`)
                            valide = false
                        }
                    } else {
                        const columns = allColumnsNames.filter(nom => nom == col.nom)
                        if (columns.length == 1) {
                            col.table = tablesList.filter(table => db.tables[table.index].columns.map(c => c.nom).includes(col.nom))[0]
                            col.index = db.tables[col.table.index].columns.map(col => col.nom).indexOf(col.nom)
                        } else if (columns.length > 1) {
                            print(`Le nom de colonne "${col.nom}" est présent dans plusieurs tables proposées`)
                            valide = false
                        } else {
                            print(`Le nom de colonne "${col.nom}" n'est présent dans aucune table proposée`)
                            valide = false
                        }
                    }
                })
            }
            return [valide, columnsList, tablesList]
        }
        /*
         * traite le mot-clé mysql 'SELECT'
         */
        function select(requete, index) {
            if (requete.length > index + 1) {
                if (requete[index+1].toUpperCase() == "DATABASE") {
                    selectDatabase(requete, index + 1)
                } else if (currentDatabase) {
                    selectFrom(requete, index)
                } else {
                    print("Aucune base de données sélectionnée")
                }
            } else {
                print("Requete incomplète")
            }    
        }
        /*
         * traite la commande mysql 'SELECT database()'
         */
        function selectDatabase(requete, index) {
            if (requete.length > index+2) {
                if (requete[index+1] == "(" && requete[index+2] == ")") {
                    if (currentDatabase) {
                        print(`La base de données "${currentDatabase.nom}" est actuellement selectionnée.`)
                    } else {
                        print("Aucune base de données n'est sélectionnée")
                    }
                } else {
                    print("Erreur de syntaxe")
                }
            } else {
                print("Requete incomplète")
            }
        }
        /*
         * traite la commande mysql 'SELECT FROM'
         */
        function selectFrom(requete, index) {
            const db = currentDatabase
            const keywords = {
                "WHERE": unimplemented,
                "GROUP BY": unimplemented,
                "HAVING": unimplemented,
                "ORDER BY": unimplemented,
                "LIMIT": unimplemented,
            }
            var valide, columnsList, tablesList
            [valide, index, columnsList] = exploreColumns(requete, index, [])
            if (valide) {
                if (requete.length > index+1 && requete[index+1].toUpperCase() == 'FROM') {
                    [valide, index, tablesList] = exploreTables(requete, index+1, [])
                    if (valide) {
                        [valide, columnsList, tablesList] = checkSelectFrom(columnsList, tablesList)
                    }
                    if (valide) {
                        if (requete.length > index+1) {
                            print("to be continued")
                        }
                        else {
                            const entete = columnsList.map(col => col.alias)
                            const combinaisons = produitCartesien(tablesList.map(table => db.tables[table.index].data))
                            console.log(combinaisons)
                            const keepIndex = [[0,1], [0,2]]
                            const data = combinaisons.map(elem => keepIndex.map(L => elem[L[0]][L[1]]))
                            data.unshift(entete)
                            printTable(data)
                        }
                    } else {
                        print("erreur de syntaxe")
                    }
                } else {
                    print(`Requete incomplète`)
                }
            }
        }
        /*
         * retourne un message indiquant que la commande mysql est non implémentée
         */
        function unimplemented(requete, index) {
            print(`La commande "${requete[index]}" n'est pas implémentée pour le moment.`)
        }
        /*
         * interprete la commande mysql saisie dans le champ de texte requete
         */
        function interpreter(event) {
            event.preventDefault()
            const originalReq = document.getElementById("requete").value
            var req = originalReq
            req = req.replace(/(\r\n|\n\r|\r|\n)/g, " ")
            const listChar = ["(", ")", ";", ","]
            listChar.forEach(char => req = req.split(char).join(" "+char+" "))
            requete = req.split(" ").filter(term => term != "")
            print('<font style="color: #00ff00">> ' + originalReq + "</font>")
            console.log(requete)
            checkKeyword(requete, 0, mainKeywords)
        }
        document.getElementById("requete-container").addEventListener("submit", interpreter)
        
        /*
         * un exemple de database sur les sériers et acteurs des Emmy Awards 2018
         */
        const db_emmy = new Database("emmy18")
        const tb_series = new Table("series")
        tb_series.columns = [new Column("id", "SMALLINT"),
                             new Column("nom", "VARCHAR"),
                             new Column("diffuseur", "VARCHAR")]
        tb_series.data = [[1, "Game of Thrones", "HBO"],
                          [2, "The Americans", "FX"],
                          [3, "The Crown", "Netflix"],
                          [4, "The Handmaid's Tale : La Servante écarlate", "Hulu"],
                          [5, "Stranger Things", "Netflix"],
                          [6, "This Is Us", "NBC"],
                          [7, "Westworld", "HBO"],
                          [8, "Ozark", "Netflix"],
                          [9, "Orphan Black", "BBC America"],
                          [10, "Killing Eve", "BBC America"],
                          [11, "Homeland", "Showtime"],
                          [12, "Mme Maisel, femme fabuleuse", "Amazon"],
                          [13, "Atlanta", "FX"],
                          [14, "Barry", "HBO"],
                          [15, "Black-ish", "ABC"],
                          [16, "Larry et son nombril", "HBO"],
                          [17, "GLOW", "Netflix"],
                          [18, "Silicon Valley", "HBO"],
                          [19, "Unbreakable Kimmy Schmidt", "Netflix"],
                          [20, "The Good Place", "NBC"],
                          [21, "Shameless", "Showtime"],
                          [22, "Better Things", "FX"],
                          [23, "Mom", "CBS"],
                          [24, "Insecure", "HBO"],
                          [25, "Grace et Frankie", "Netflix"],
                          [26, "Baskets", "FX"],
                          [27, "Roseanne", "ABC"],
                          [28, "Will et Grace", "NBC"]]
        db_emmy.tables.push(tb_series)
        const tb_acteurs = new Table("acteurs")
        tb_acteurs.columns = [new Column("id", "SMALLINT"),
                             new Column("nom", "VARCHAR"),
                             new Column("prenom", "VARCHAR"),
                             new Column("sexe", "CHAR(1)"),
                             new Column("pays", "VARCHAR"),
                             new Column("date_de_naissance", "DATE"),]
        tb_acteurs.data = [[1, "Rhys", "Matthew", "M", "Pays de Galles", "1974-11-08"],
                           [2, "Bateman", "Jason", "M", "États-Unis", "1969-01-14"],
                           [3, "Brown", "Sterling K.", "M", "États-Unis", "1976-04-05"],
                           [4, "Harris", "Ed", "M", "États-Unis", "1950-11-28"],
                           [5, "Ventimiglia", "Milo", "M", "États-Unis", "1977-07-08"],
                           [6, "Wright", "Jeffrey", "M", "États-Unis", "1965-12-07"],
                           [7, "Foy", "Claire", "F", "Angleterre", "1984-04-16"],
                           [8, "Maslany", "Tatiana", "F", "Canada", "1985-09-22"],
                           [9, "Moss", "Elisabeth", "F", "États-Unis", "1982-07-24"],
                           [10, "Oh", "Sandra", "F", "Canada", "1970-11-30"],
                           [11, "Russell", "Keri", "F", "États-Unis", "1976-03-23"],
                           [12, "Wood", "Evan Rachel", "F", "États-Unis", "1987-09-07"],
                           [13, "Dinklage", "Peter", "M", "États-Unis", "1969-06-11"],
                           [14, "Coster-Waldau", "Nikolaj", "M", "Danemark", "1970-07-27"],
                           [15, "Fiennes", "Joseph", "M", "Angleterre", "1970-05-27"],
                           [16, "Harbour", "David", "M", "États-Unis", "1975-04-10"],
                           [17, "Patinkin", "Mandy", "M", "États-Unis", "1952-11-30"],
                           [18, "Smith", "Matthew", "M", "Angleterre", "1982-10-28"],
                           [19, "Newton", "Thandie", "F", "Angleterre", "1972-11-06"],
                           [20, "Bledel", "Alexis", "F", "États-Unis", "1981-09-16"],
                           [21, "Brown", "Millie Bobby", "F", "Espagne", "2004-02-19"],
                           [22, "Dowd", "Ann", "F", "États-Unis", "1956-01-30"],
                           [23, "Heady", "Lena", "F", "Royaume-Uni", "1973-10-03"],
                           [24, "Kirby", "Vanessa", "F", "Angleterre", "1988-04-18"],
                           [25, "Strahovski", "Yvonne", "F", "Australie", "1982-07-30"]]
        db_emmy.tables.push(tb_acteurs)
        const tb_tourne = new Table("tourne")
        tb_tourne.columns = [new Column("id_acteur", "SMALLINT"),
                             new Column("id_film", "SMALLINT"),
                             new Column("role", "VARCHAR")]
        tb_tourne.data = [[1, 2, "Philip Jennings"],
                          [2, 8, 'Martin "Marty" Byrde'],
                          [3, 6, "Randall Pearson"],
                          [4, 7, "l'homme en noir"],
                          [5, 6, "Jack Pearson"],
                          [6, 7, "Bernard Lowe"],
                          [7, 3, "Élisabeth II"],
                          [8, 9, "Sarah Manning"],
                          [8, 9, "Elizabeth « Beth » Childs"],
                          [8, 9, "Cosima Niehaus"],
                          [8, 9, "Alison Hendrix"],
                          [8, 9, "Helena"],
                          [8, 9, "Rachel Duncan"],
                          [8, 9, "Katja Obinger"],
                          [8, 9, "Danielle Fournier"],
                          [8, 9, "Aryanna Giordano"],
                          [8, 9, "Janika Zingler"],
                          [8, 9, "Jennifer Fitzsimmons"],
                          [8, 9, "Tony Sawicki"],
                          [8, 9, "Krystal Goderitch"],
                          [8, 9, "MK (Veera Suominen)"],
                          [8, 9, "Niki"],
                          [8, 9, "Miriam Johnson"],
                          [8, 9, "Camilla Torres"],
                          [9, 4, "June Osborne-Offred"],
                          [10, 10, "Eve Polastri"],
                          [11, 2, "Elizabeth Jennings"],
                          [12, 7, "Dolores Abernathy"],
                          [13, 1, "Tyrion Lannister"],
                          [14, 1, "Jaime Lannister"],
                          [15, 4, "Fred Waterford"],
                          [16, 5, "Jim Hopper"],
                          [17, 11, "Saul Berenson"],
                          [18, 3, "Prince Philip"],
                          [19, 7, "Maeve Millay"],
                          [20, 4, "Emily"],
                          [21, 5, "Jane Ives / Onze"],
                          [22, 4, "Tante Lydia"],
                          [23, 1, "Cersei Lannister"],
                          [24, 3, "Princesse Margaret"],
                          [25, 4, "Serena Joy Waterford"]]
        db_emmy.tables.push(tb_tourne)
        databases.push(db_emmy)
    </script>
</body>
</html>
